<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="1000 Miglia">
<title>1000 Miglia Participant Tools</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120' width='120' height='120'%3E%3Cdefs%3E%3CclipPath id='circle'%3E%3Ccircle cx='60' cy='60' r='44'/%3E%3C/clipPath%3E%3CclipPath id='leftHalf'%3E%3Cpolygon points='0,0 60,0 60,120 0,120'/%3E%3C/clipPath%3E%3CclipPath id='rightHalf'%3E%3Cpolygon points='60,0 120,0 120,120 60,120'/%3E%3C/clipPath%3E%3Cpattern id='checker' width='14' height='14' patternUnits='userSpaceOnUse'%3E%3Crect width='14' height='14' fill='%23fff'/%3E%3Crect width='7' height='7' fill='%23111'/%3E%3Crect x='7' y='7' width='7' height='7' fill='%23111'/%3E%3C/pattern%3E%3C/defs%3E%3Crect width='120' height='120' rx='26' fill='%230a0a14'/%3E%3Ccircle cx='60' cy='60' r='45' fill='none' stroke='%23333' stroke-width='2'/%3E%3Cg clip-path='url(%23circle)'%3E%3Cg clip-path='url(%23leftHalf)'%3E%3Crect width='120' height='120' fill='url(%23checker)' opacity='0.85'/%3E%3C/g%3E%3Cg clip-path='url(%23rightHalf)'%3E%3Crect width='120' height='120' fill='%23c41e3a'/%3E%3C/g%3E%3C/g%3E%3Cline x1='60' y1='16' x2='60' y2='104' stroke='%230a0a14' stroke-width='3'/%3E%3Ctext x='82' y='56' font-family='SF Mono,Menlo,monospace' font-size='11' font-weight='700' fill='%23fff' text-anchor='middle' opacity='0.6'%3E0%3C/text%3E%3Ctext x='82' y='72' font-family='SF Mono,Menlo,monospace' font-size='18' font-weight='900' fill='%23fff' text-anchor='middle'%3E.00%3C/text%3E%3Ccircle cx='60' cy='60' r='44' fill='none' stroke='%23555' stroke-width='1.5'/%3E%3C/svg%3E">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<meta name="theme-color" content="#0a0a0f">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0a0f; }
</style>
</head>
<body>
<div id="root"></div>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script type="text/babel">
const { useState, useRef, useCallback, useEffect } = React;

// All TT stage data from the official itinerary
const TRAINING_STAGES = [
  { id: "T1", dist: "90 m", target: 15.0 },
  { id: "T2", dist: "40 m", target: 7.0 },
  { id: "T3", dist: "270 m", target: 32.0 },
  { id: "T4", dist: "50 m", target: 8.0 },
  { id: "T5", dist: "90 m", target: 13.0 },
];

const STAGES = {
  "FRI \u2014 Training Ride 1": TRAINING_STAGES,
  "FRI \u2014 Training Ride 2": TRAINING_STAGES,
  "FRI \u2014 Training Ride 3": TRAINING_STAGES,
  "FRI \u2014 Training Ride 4": TRAINING_STAGES,
  "FRI \u2014 Training Ride 5": TRAINING_STAGES,
  "SAT \u2014 Centennial AM": [
    { id: "TT01", dist: "40 m", target: 9.0 },
    { id: "TT02", dist: "40 m", target: 7.0 },
    { id: "TT03", dist: "50 m", target: 12.0 },
    { id: "TT04", dist: "50 m", target: 9.0 },
    { id: "TT05", dist: "60 m", target: 10.0 },
  ],
  "SAT \u2014 Centennial PM": [
    { id: "TT06", dist: "40 m", target: 9.0 },
    { id: "TT07", dist: "40 m", target: 7.0 },
    { id: "TT08", dist: "50 m", target: 12.0 },
    { id: "TT09", dist: "50 m", target: 9.0 },
    { id: "TT10", dist: "60 m", target: 10.0 },
  ],
  "SAT \u2014 Innisbrook": [
    { id: "TT11", dist: "60 m", target: 13.0 },
    { id: "TT12", dist: "60 m", target: 12.0 },
    { id: "TT13", dist: "60 m", target: 11.0 },
    { id: "TT14", dist: "50 m", target: 11.0 },
    { id: "TT15", dist: "40 m", target: 8.0 },
  ],
  "SUN \u2014 Innisbrook": [
    { id: "TT16", dist: "40 m", target: 9.0 },
    { id: "TT17", dist: "50 m", target: 11.0 },
    { id: "TT18", dist: "60 m", target: 11.0 },
    { id: "TT19", dist: "60 m", target: 12.0 },
    { id: "TT20", dist: "60 m", target: 13.0 },
  ],
  "SUN \u2014 Lakeland AM": [
    { id: "TT21", dist: "50 m", target: 10.0 },
    { id: "TT22", dist: "40 m", target: 8.0 },
    { id: "TT23", dist: "50 m", target: 9.0 },
    { id: "TT24", dist: "50 m", target: 8.0 },
    { id: "TT25", dist: "40 m", target: 8.0 },
  ],
  "SUN \u2014 Lakeland PM": [
    { id: "TT26", dist: "50 m", target: 10.0 },
    { id: "TT27", dist: "40 m", target: 8.0 },
    { id: "TT28", dist: "50 m", target: 9.0 },
    { id: "TT29", dist: "50 m", target: 8.0 },
    { id: "TT30", dist: "40 m", target: 8.0 },
  ],
  "SUN \u2014 Sebring": [
    { id: "TT31", dist: "70 m", target: 13.0 },
    { id: "TT32", dist: "90 m", target: 12.0 },
    { id: "TT33", dist: "110 m", target: 20.0 },
    { id: "TT34", dist: "40 m", target: 7.0 },
    { id: "TT35", dist: "80 m", target: 13.0 },
  ],
  "MON \u2014 Palm Beach": [
    { id: "TT36", dist: "40 m", target: 9.0 },
    { id: "TT37", dist: "40 m", target: 7.0 },
    { id: "TT38", dist: "40 m", target: 7.0 },
    { id: "TT39", dist: "60 m", target: 11.0 },
    { id: "TT40", dist: "40 m", target: 8.0 },
  ],
};

const AT_INFO = [
  { id: "AT1", name: "Casey Key", speed: "37 kph / 23 mph", dist: "6.1 km / 3.8 mi", day: "SAT", targetKph: 37, targetMph: 23 },
  { id: "AT2", name: "Scenic Hwy", speed: "63 kph / 39 mph", dist: "6.9 km / 4.3 mi", day: "SUN", targetKph: 63, targetMph: 39 },
  { id: "AT3", name: "Sebring Track", speed: "49 kph / 30 mph", dist: "4.2 km / 2.6 mi", day: "SUN", targetKph: 49, targetMph: 30 },
  { id: "AT4", name: "Jupiter Island", speed: "45 kph / 28 mph", dist: "5.7 km / 3.5 mi", day: "SUN", targetKph: 45, targetMph: 28 },
];

// Audio feedback
let audioCtx = null;
function playBeep(quality) {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.type = "sine";
  osc.frequency.value = quality === "perfect" ? 880 : quality === "early" ? 440 : 330;
  gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.15);
  osc.start(audioCtx.currentTime);
  osc.stop(audioCtx.currentTime + 0.15);
}

// localStorage helpers
const STORAGE_KEY = "miglia_data";
function loadData() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return { completed: [], savedSplits: {} };
    return JSON.parse(raw);
  } catch { return { completed: [], savedSplits: {} }; }
}
function saveData(completed, savedSplits) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify({
    completed: Array.from(completed),
    savedSplits,
  }));
}

function RallyTimer() {
  const stored = useRef(loadData());
  const [view, setView] = useState("menu");
  const [selectedGroup, setSelectedGroup] = useState(null);
  const [stageIndex, setStageIndex] = useState(0);
  const [running, setRunning] = useState(false);
  const [elapsed, setElapsed] = useState(0);
  const [splits, setSplits] = useState([]);
  const [completed, setCompleted] = useState(() => new Set(stored.current.completed));
  const [savedSplits, setSavedSplits] = useState(() => stored.current.savedSplits);
  const lapStartRef = useRef(null);
  const rafRef = useRef(null);
  const [flash, setFlash] = useState(null);

  // AT GPS speed tracking
  const [selectedAT, setSelectedAT] = useState(null);
  const [atTracking, setAtTracking] = useState(false);
  const [currentSpeed, setCurrentSpeed] = useState(null);
  const [gpsAccuracy, setGpsAccuracy] = useState(null);
  const [gpsError, setGpsError] = useState(null);
  const [speedHistory, setSpeedHistory] = useState([]);
  const [unitPref, setUnitPref] = useState("kph");
  const watchIdRef = useRef(null);
  const atWakeLockRef = useRef(null);
  const prevSpeedStatus = useRef(null);

  // Persist to localStorage whenever completed or savedSplits change
  useEffect(() => {
    saveData(completed, savedSplits);
  }, [completed, savedSplits]);

  const stages = selectedGroup ? STAGES[selectedGroup] : [];
  const currentStage = stages[stageIndex] || null;
  const isLastStage = stageIndex >= stages.length - 1;

  const tick = useCallback(() => {
    if (lapStartRef.current) {
      setElapsed(performance.now() - lapStartRef.current);
    }
    rafRef.current = requestAnimationFrame(tick);
  }, []);

  useEffect(() => {
    return () => { if (rafRef.current) cancelAnimationFrame(rafRef.current); };
  }, []);

  // Wake lock: keep screen on while timer is running
  const wakeLockRef = useRef(null);
  useEffect(() => {
    if (running && navigator.wakeLock) {
      navigator.wakeLock.request("screen").then((lock) => {
        wakeLockRef.current = lock;
      }).catch(() => {});
    }
    return () => {
      if (wakeLockRef.current) {
        wakeLockRef.current.release().catch(() => {});
        wakeLockRef.current = null;
      }
    };
  }, [running]);

  // GPS tracking for AT stages
  const msToKph = (ms) => ms * 3.6;
  const msToMph = (ms) => ms * 2.237;

  const smoothedSpeed = speedHistory.length > 0
    ? speedHistory.reduce((a, b) => a + b, 0) / speedHistory.length
    : null;

  const displaySpeed = smoothedSpeed !== null
    ? (unitPref === "kph" ? msToKph(smoothedSpeed) : msToMph(smoothedSpeed))
    : null;

  const getSpeedStatus = (current, target) => {
    if (current === null) return "waiting";
    const pct = ((current - target) / target) * 100;
    if (Math.abs(pct) <= 3) return "on-pace";
    if (pct > 0) return "too-fast";
    return "too-slow";
  };

  const speedStatusColor = (status) => {
    if (status === "on-pace") return "#4ade80";
    if (status === "too-fast") return "#ef4444";
    if (status === "too-slow") return "#60a5fa";
    return "#667";
  };

  const startATTracking = (atIndex) => {
    setSelectedAT(atIndex);
    setAtTracking(false);
    setCurrentSpeed(null);
    setGpsAccuracy(null);
    setGpsError(null);
    setSpeedHistory([]);
    prevSpeedStatus.current = null;
    setView("at-speed");
  };

  const beginGPS = () => {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === "suspended") audioCtx.resume();
    setAtTracking(true);
    setGpsError(null);
  };

  const stopGPS = () => {
    setAtTracking(false);
    setCurrentSpeed(null);
    setSpeedHistory([]);
    prevSpeedStatus.current = null;
  };

  // GPS watchPosition effect
  useEffect(() => {
    if (!atTracking) return;
    if (!navigator.geolocation) {
      setGpsError("GPS not available on this device");
      return;
    }
    const id = navigator.geolocation.watchPosition(
      (position) => {
        setGpsError(null);
        setGpsAccuracy(position.coords.accuracy);
        const rawSpeed = position.coords.speed;
        if (rawSpeed !== null && rawSpeed >= 0) {
          setCurrentSpeed(rawSpeed);
          setSpeedHistory((prev) => [...prev, rawSpeed].slice(-5));
        } else {
          setCurrentSpeed(0);
        }
      },
      (error) => {
        if (error.code === 1) setGpsError("Location permission denied");
        else if (error.code === 2) setGpsError("GPS signal unavailable");
        else if (error.code === 3) setGpsError("GPS timed out");
        else setGpsError("GPS error");
      },
      { enableHighAccuracy: true, maximumAge: 1000, timeout: 10000 }
    );
    watchIdRef.current = id;
    return () => {
      navigator.geolocation.clearWatch(id);
      watchIdRef.current = null;
    };
  }, [atTracking]);

  // Wake lock for AT GPS tracking
  useEffect(() => {
    if (atTracking && navigator.wakeLock) {
      navigator.wakeLock.request("screen").then((lock) => {
        atWakeLockRef.current = lock;
      }).catch(() => {});
    }
    return () => {
      if (atWakeLockRef.current) {
        atWakeLockRef.current.release().catch(() => {});
        atWakeLockRef.current = null;
      }
    };
  }, [atTracking]);

  // Audio feedback on speed zone transitions
  useEffect(() => {
    if (!atTracking || displaySpeed === null || selectedAT === null) return;
    const at = AT_INFO[selectedAT];
    const target = unitPref === "kph" ? at.targetKph : at.targetMph;
    if (displaySpeed < 2) return; // ignore when nearly stopped
    const status = getSpeedStatus(displaySpeed, target);
    if (status !== prevSpeedStatus.current && status !== "waiting") {
      if (status === "on-pace") playBeep("perfect");
      else if (status === "too-fast") playBeep("early");
      else playBeep("late");
      prevSpeedStatus.current = status;
    }
  }, [displaySpeed, atTracking, selectedAT, unitPref]);

  const handleStart = () => {
    // Init audio context on user gesture (required for iOS Safari)
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === "suspended") audioCtx.resume();
    lapStartRef.current = performance.now();
    setElapsed(0);
    setRunning(true);
    setFlash(null);
    rafRef.current = requestAnimationFrame(tick);
  };

  const handleLap = () => {
    if (!running || !currentStage) return;
    const now = performance.now();
    const lapTime = (now - lapStartRef.current) / 1000;
    const delta = lapTime - currentStage.target;
    const absDelta = Math.abs(delta);

    let quality;
    if (absDelta <= 0.5) quality = "perfect";
    else if (delta < 0) quality = "early";
    else quality = "late";

    setFlash(quality);
    setTimeout(() => setFlash(null), 800);
    playBeep(quality);

    const newSplit = { id: currentStage.id, target: currentStage.target, actual: lapTime, delta, quality };

    setSplits((prev) => {
      const updated = [newSplit, ...prev];
      if (isLastStage) {
        setSavedSplits((s) => ({ ...s, [selectedGroup]: updated }));
      }
      return updated;
    });

    if (isLastStage) {
      if (rafRef.current) cancelAnimationFrame(rafRef.current);
      setRunning(false);
      setElapsed(0);
      lapStartRef.current = null;
      setStageIndex(stages.length);
      setCompleted((prev) => new Set(prev).add(selectedGroup));
    } else {
      lapStartRef.current = now;
      setElapsed(0);
      setStageIndex(stageIndex + 1);
    }
  };

  const handleReset = () => {
    if (rafRef.current) cancelAnimationFrame(rafRef.current);
    setRunning(false);
    setElapsed(0);
    lapStartRef.current = null;
  };

  const formatTime = (ms) => {
    const totalSec = ms / 1000;
    const sec = Math.floor(totalSec);
    const tenths = Math.floor((totalSec - sec) * 10);
    const hundredths = Math.floor((totalSec - sec) * 100) % 10;
    return { sec, tenths, hundredths, totalSec };
  };

  const toggleComplete = (key, e) => {
    e.stopPropagation();
    setCompleted((prev) => {
      const next = new Set(prev);
      if (next.has(key)) {
        next.delete(key);
        setSavedSplits((s) => { const n = { ...s }; delete n[key]; return n; });
      } else {
        next.add(key);
      }
      return next;
    });
  };

  const selectGroup = (group) => {
    setSelectedGroup(group);
    setElapsed(0);
    setRunning(false);
    lapStartRef.current = null;
    if (completed.has(group) && savedSplits[group]) {
      setSplits(savedSplits[group]);
      setStageIndex(STAGES[group].length); // triggers done view
    } else {
      setStageIndex(0);
      setSplits([]);
    }
    setView("timer");
  };

  const [shareMsg, setShareMsg] = useState(null);

  const buildResultsText = () => {
    const lines = ["1000 MIGLIA FLORIDA 2026 \u2014 RESULTS", ""];
    const dayHeadings = [
      { day: "FRIDAY FEB 20 (Day 1 \u2014 Training)", groups: [
        "FRI \u2014 Training Ride 1", "FRI \u2014 Training Ride 2", "FRI \u2014 Training Ride 3",
        "FRI \u2014 Training Ride 4", "FRI \u2014 Training Ride 5",
      ]},
      { day: "SATURDAY FEB 21 (Day 2 \u2014 Naples \u2192 Tampa)", groups: [
        "SAT \u2014 Centennial AM", "SAT \u2014 Centennial PM", "SAT \u2014 Innisbrook",
      ]},
      { day: "SUNDAY FEB 22 (Day 3 \u2014 Tampa \u2192 WPB)", groups: [
        "SUN \u2014 Innisbrook", "SUN \u2014 Lakeland AM", "SUN \u2014 Lakeland PM",
        "SUN \u2014 Sebring",
      ]},
      { day: "MONDAY FEB 23 (Day 4 \u2014 WPB \u2192 Miami)", groups: [
        "MON \u2014 Palm Beach",
      ]},
    ];
    let hasResults = false;
    for (const section of dayHeadings) {
      const dayGroups = section.groups.filter((g) => savedSplits[g]);
      if (dayGroups.length === 0) continue;
      hasResults = true;
      lines.push("=".repeat(40));
      lines.push(section.day);
      lines.push("=".repeat(40));
      lines.push("");
      for (const group of dayGroups) {
        const shortName = group.split(" \u2014 ")[1];
        lines.push(shortName);
        const ordered = [...savedSplits[group]].reverse();
        let totalDelta = 0;
        for (const s of ordered) {
          const sign = s.delta >= 0 ? "+" : "\u2212";
          lines.push(`  ${s.id}  ${s.target.toFixed(1)}s \u2192 ${s.actual.toFixed(2)}s  (${sign}${Math.abs(s.delta).toFixed(2)}s)`);
          totalDelta += Math.abs(s.delta);
        }
        lines.push(`  Total penalty: ${totalDelta.toFixed(2)}s`);
        lines.push("");
      }
    }
    if (!hasResults) return null;
    return lines.join("\n");
  };

  const shareResults = async () => {
    const text = buildResultsText();
    if (!text) {
      setShareMsg("No completed TTs to share");
      setTimeout(() => setShareMsg(null), 2000);
      return;
    }
    if (navigator.share) {
      try {
        await navigator.share({ title: "1000 Miglia Results", text });
        return;
      } catch {}
    }
    try {
      await navigator.clipboard.writeText(text);
      setShareMsg("Copied to clipboard");
    } catch {
      setShareMsg("Could not share");
    }
    setTimeout(() => setShareMsg(null), 2000);
  };

  const SCHEDULE = [
    { day: "FRIDAY FEB 20", label: "Training \u2014 JB Proving Grounds, Naples", items: [
      { type: "tt", group: "FRI \u2014 Training Ride 1" },
      { type: "tt", group: "FRI \u2014 Training Ride 2" },
      { type: "tt", group: "FRI \u2014 Training Ride 3" },
      { type: "tt", group: "FRI \u2014 Training Ride 4" },
      { type: "tt", group: "FRI \u2014 Training Ride 5" },
    ]},
    { day: "SATURDAY FEB 21", label: "Leg 1 \u2014 Naples \u2192 Venice \u2192 Tampa", items: [
      { type: "tt", group: "SAT \u2014 Centennial AM" },
      { type: "tt", group: "SAT \u2014 Centennial PM" },
      { type: "at", index: 0 },
      { type: "tt", group: "SAT \u2014 Innisbrook" },
    ]},
    { day: "SUNDAY FEB 22", label: "Leg 2 \u2014 Tampa \u2192 Lakeland \u2192 Sebring \u2192 WPB", items: [
      { type: "tt", group: "SUN \u2014 Innisbrook" },
      { type: "tt", group: "SUN \u2014 Lakeland AM" },
      { type: "tt", group: "SUN \u2014 Lakeland PM" },
      { type: "at", index: 1 },
      { type: "at", index: 2 },
      { type: "tt", group: "SUN \u2014 Sebring" },
      { type: "at", index: 3 },
    ]},
    { day: "MONDAY FEB 23", label: "Leg 3 \u2014 WPB \u2192 Miami", items: [
      { type: "tt", group: "MON \u2014 Palm Beach" },
    ]},
  ];

  // MENU VIEW
  if (view === "menu") {
    return (
      <div style={S.container}>
        <div style={S.menuHeader}>
          <div style={S.menuFlag}>{"\uD83C\uDFC1"}</div>
          <div style={S.menuTitle}>1000 MIGLIA</div>
          <div style={S.menuSubtitle}>EXPERIENCE FLORIDA 2026</div>
          <div style={S.menuDivider} />
          <div style={S.menuLabel}>RALLY TOOLS</div>
        </div>

        {SCHEDULE.map((day) => (
          <div key={day.day} style={S.menuSection}>
            <div style={S.menuDayTitle}>{day.day}</div>
            <div style={S.menuSectionSub}>{day.label}</div>
            <div style={S.menuGrid}>
              {day.items.map((item, i) => {
                if (item.type === "tt") {
                  const stgs = STAGES[item.group];
                  const shortName = item.group.split(" \u2014 ")[1];
                  const isDone = completed.has(item.group);
                  return (
                    <button key={i} style={{...S.menuBtn, opacity: isDone ? 0.5 : 1}} onClick={() => selectGroup(item.group)}>
                      <span style={S.menuBtnLabel}>
                        <span style={S.ttBadge}>TT</span> {shortName}
                      </span>
                      <span style={S.menuBtnRight}>
                        <span style={S.menuBtnInfo}>{stgs.length} stages</span>
                        <span style={{...S.checkBtn, borderColor: isDone ? "#4ade80" : "#333", color: isDone ? "#4ade80" : "#333"}} onClick={(e) => toggleComplete(item.group, e)}>
                          {isDone ? "\u2713" : ""}
                        </span>
                      </span>
                    </button>
                  );
                } else {
                  const at = AT_INFO[item.index];
                  const atKey = at.id;
                  const isDone = completed.has(atKey);
                  return (
                    <button key={i} style={{...S.menuBtn, borderColor: "#3b2a5c", opacity: isDone ? 0.5 : 1}} onClick={() => startATTracking(item.index)}>
                      <span style={S.menuBtnLabel}>
                        <span style={S.atBadge}>AT</span> {at.name}
                      </span>
                      <span style={S.menuBtnRight}>
                        <span style={S.menuBtnInfo}>{at.speed.split(" / ")[0]}</span>
                        <span style={{...S.checkBtn, borderColor: isDone ? "#4ade80" : "#333", color: isDone ? "#4ade80" : "#333"}} onClick={(e) => toggleComplete(atKey, e)}>
                          {isDone ? "\u2713" : ""}
                        </span>
                      </span>
                    </button>
                  );
                }
              })}
            </div>
          </div>
        ))}

        <div style={S.shareContainer}>
          <button style={S.shareBtn} onClick={shareResults}>
            SHARE RESULTS
          </button>
          {shareMsg && <div style={S.shareMsg}>{shareMsg}</div>}
        </div>
      </div>
    );
  }

  // AT GPS SPEED VIEW
  if (view === "at-speed" && selectedAT !== null) {
    const at = AT_INFO[selectedAT];
    const targetSpeed = unitPref === "kph" ? at.targetKph : at.targetMph;
    const speedStatus = getSpeedStatus(displaySpeed, targetSpeed);
    const statusColor = speedStatusColor(speedStatus);
    const atBg = speedStatus === "on-pace" ? "#0a2a0a" : speedStatus === "too-fast" ? "#2a0a0a" : speedStatus === "too-slow" ? "#0a0a2a" : "#0a0a0f";

    const delta = displaySpeed !== null ? displaySpeed - targetSpeed : null;
    const deltaAbs = delta !== null ? Math.abs(delta).toFixed(1) : null;
    const deltaSign = delta !== null ? (delta >= 0 ? "+" : "\u2212") : null;
    const instruction = speedStatus === "on-pace" ? "ON PACE" : speedStatus === "too-fast" ? "SLOW DOWN" : speedStatus === "too-slow" ? "SPEED UP" : "";

    return (
      <div style={{...S.container, backgroundColor: atTracking ? atBg : "#0a0a0f", transition: "background-color 0.5s", overflowY: "hidden"}}>
        <div style={S.topBar}>
          <button style={S.backBtn} onClick={() => { stopGPS(); setView("menu"); }}>
            {"\u2190"} BACK
          </button>
          <span style={S.topBarTitle}>{at.id} {"\u2014"} {at.name}</span>
        </div>

        <div style={S.atSpeedLayout}>
          <div style={S.atSpeedScrollArea}>
            <div style={S.atSpeedInfo}>
              <div style={S.atSpeedInfoRow}>
                <span style={S.atSpeedDay}>{at.day}</span>
                <span style={S.atSpeedDist}>{at.dist}</span>
              </div>
              <div style={S.atSpeedNote}>5 detection points {"\u2014"} hold steady speed</div>
            </div>

            <div style={S.atTargetArea}>
              <div style={S.atTargetLabel}>TARGET</div>
              <div style={S.atTargetSpeed}>{targetSpeed} {unitPref}</div>
            </div>

            <div style={S.atSpeedDisplay}>
              <div style={{...S.atCurrentSpeed, color: atTracking ? statusColor : "#333"}}>
                {atTracking && displaySpeed !== null ? displaySpeed.toFixed(1) : "--"}
              </div>
              <div style={S.atSpeedUnit}>{unitPref}</div>
              {atTracking && displaySpeed !== null && displaySpeed >= 2 && (
                <div style={{...S.atDeltaRow, color: statusColor}}>
                  <div style={S.atDeltaValue}>{deltaSign}{deltaAbs} {unitPref}</div>
                  <div style={S.atDeltaInstruction}>{instruction}</div>
                </div>
              )}
              {atTracking && (displaySpeed === null || displaySpeed < 2) && (
                <div style={S.atWaitingText}>Acquiring speed...</div>
              )}
              {gpsError && (
                <div style={S.atErrorText}>{gpsError}</div>
              )}
            </div>

            <div style={S.atUnitToggleRow}>
              <div style={S.atUnitToggle}>
                <button style={{...S.atUnitBtn, ...(unitPref === "kph" ? S.atUnitBtnActive : S.atUnitBtnInactive)}} onClick={() => setUnitPref("kph")}>KPH</button>
                <button style={{...S.atUnitBtn, ...(unitPref === "mph" ? S.atUnitBtnActive : S.atUnitBtnInactive)}} onClick={() => setUnitPref("mph")}>MPH</button>
              </div>
            </div>

            {atTracking && gpsAccuracy !== null && (
              <div style={{...S.atGpsStatus, color: gpsAccuracy < 10 ? "#4ade80" : gpsAccuracy < 25 ? "#fbbf24" : "#ef4444"}}>
                GPS {"\u00B1"}{Math.round(gpsAccuracy)}m
              </div>
            )}
          </div>

          <div style={{...S.btnContainerFixed, backgroundColor: atTracking ? atBg : "#0a0a0f", transition: "background-color 0.5s"}}>
            {!atTracking ? (
              <button style={S.atStartBtn} onClick={beginGPS}>
                <div style={S.btnText}>START GPS</div>
                <div style={S.btnSub}>begin speed tracking</div>
              </button>
            ) : (
              <button style={S.atStopBtn} onClick={stopGPS}>
                <div style={S.btnText}>STOP</div>
                <div style={S.btnSub}>end speed tracking</div>
              </button>
            )}
          </div>
        </div>
      </div>
    );
  }

  // TIMER VIEW
  const done = stageIndex >= stages.length;
  const { sec, tenths, hundredths } = formatTime(elapsed);

  let bgColor = "#0a0a0f";
  if (flash === "perfect") bgColor = "#0a2a0a";
  if (flash === "early") bgColor = "#2a0a0a";
  if (flash === "late") bgColor = "#0a0a2a";

  return (
    <div style={{...S.container, backgroundColor: bgColor, transition: "background-color 0.3s", overflowY: done ? "auto" : "hidden"}}>
      <div style={S.topBar}>
        <button style={S.backBtn} onClick={() => { handleReset(); setView("menu"); }}>
          {"\u2190"} BACK
        </button>
        <span style={S.topBarTitle}>{selectedGroup}</span>
      </div>

      {done ? (
        <div style={S.doneContainer}>
          <div style={S.doneEmoji}>{"\uD83C\uDFC1"}</div>
          <div style={S.doneText}>ALL STAGES COMPLETE</div>
          <div style={S.splitsList}>
            {splits.map((s, i) => (
              <SplitRow key={i} split={s} />
            ))}
          </div>
        </div>
      ) : currentStage ? (
        <div style={S.timerLayout}>
          <div style={S.timerScrollArea}>
            <div style={S.stageInfo}>
              <div style={S.stageRow}>
                <span style={S.stageId}>{currentStage.id}</span>
                <span style={S.stageDist}>{currentStage.dist}</span>
                <span style={S.stageProgress}>
                  {stageIndex + 1}/{stages.length}
                </span>
              </div>
              <div style={S.targetRow}>
                <span style={S.targetLabel}>TARGET</span>
                <span style={S.targetTime}>{currentStage.target.toFixed(1)}s</span>
              </div>
            </div>

            <div style={S.timerContainer}>
              <div style={S.timerMain}>
                <span style={S.timerSec}>{String(sec).padStart(2, "0")}</span>
                <span style={S.timerDot}>.</span>
                <span style={S.timerFrac}>
                  {tenths}{hundredths}
                </span>
              </div>
              {running && (
                <div
                  style={{
                    ...S.targetIndicator,
                    color:
                      elapsed / 1000 < currentStage.target - 1
                        ? "#888"
                        : elapsed / 1000 < currentStage.target + 0.5
                        ? "#4ade80"
                        : "#ef4444",
                  }}
                >
                  {elapsed / 1000 < currentStage.target
                    ? `${(currentStage.target - elapsed / 1000).toFixed(1)}s to go`
                    : `${((elapsed / 1000) - currentStage.target).toFixed(1)}s OVER`}
                </div>
              )}
            </div>

            {running && !isLastStage && stages[stageIndex + 1] && (
              <div style={S.nextStageBar}>
                <span style={S.nextLabel}>NEXT UP</span>
                <span style={S.nextId}>{stages[stageIndex + 1].id}</span>
                <span style={S.nextDist}>{stages[stageIndex + 1].dist}</span>
                <span style={S.nextTarget}>{stages[stageIndex + 1].target.toFixed(1)}s</span>
              </div>
            )}

            {splits.length > 0 && (
              <div style={S.splitsList}>
                <div style={S.splitsHeader}>SPLITS</div>
                {splits.slice(0, 10).map((s, i) => (
                  <SplitRow key={i} split={s} />
                ))}
              </div>
            )}
          </div>

          <div style={{...S.btnContainerFixed, backgroundColor: bgColor, transition: "background-color 0.3s"}}>
            {!running ? (
              <button style={S.startBtn} onClick={handleStart}>
                <div style={S.btnText}>START</div>
                <div style={S.btnSub}>tap at first sensor</div>
              </button>
            ) : isLastStage ? (
              <button style={S.finishBtn} onClick={handleLap}>
                <div style={S.btnText}>FINISH</div>
                <div style={S.btnSub}>tap at last sensor</div>
              </button>
            ) : (
              <button style={S.splitBtn} onClick={handleLap}>
                <div style={S.btnText}>NEXT</div>
                <div style={S.btnSub}>tap at sensor {stageIndex + 2} of {stages.length}</div>
              </button>
            )}
          </div>
        </div>
      ) : null}
    </div>
  );
}

function SplitRow({ split }) {
  const deltaColor =
    split.quality === "perfect" ? "#4ade80" : split.quality === "early" ? "#ef4444" : "#60a5fa";
  const sign = split.delta >= 0 ? "+" : "\u2212";
  return (
    <div style={S.splitRow}>
      <span style={S.splitId}>{split.id}</span>
      <span style={S.splitTarget}>{split.target.toFixed(1)}s</span>
      <span style={S.splitActual}>{split.actual.toFixed(2)}s</span>
      <span style={{...S.splitDelta, color: deltaColor}}>
        {sign}{Math.abs(split.delta).toFixed(2)}s
      </span>
    </div>
  );
}

// STYLES
const S = {
  container: {
    minHeight: "100vh", backgroundColor: "#0a0a0f", color: "#fff",
    fontFamily: "'SF Mono', 'Menlo', 'Courier New', monospace",
    userSelect: "none", WebkitUserSelect: "none",
    WebkitTapHighlightColor: "transparent", overflowY: "auto",
  },
  menuHeader: { textAlign: "center", padding: "40px 20px 20px" },
  menuFlag: { fontSize: "36px", marginBottom: "8px" },
  menuTitle: {
    fontSize: "28px", fontWeight: "900", letterSpacing: "4px", color: "#fff",
    fontFamily: "'Helvetica Neue', 'Arial Black', sans-serif",
  },
  menuSubtitle: {
    fontSize: "11px", letterSpacing: "3px", color: "#c41e3a", marginTop: "4px",
    fontFamily: "'Helvetica Neue', sans-serif",
  },
  menuDivider: {
    width: "60px", height: "3px", background: "#c41e3a", margin: "16px auto", borderRadius: "2px",
  },
  menuLabel: { fontSize: "20px", fontWeight: "700", letterSpacing: "6px", color: "#667" },
  menuSection: { padding: "12px 20px" },
  menuDayTitle: {
    fontSize: "15px", fontWeight: "800", color: "#c41e3a", letterSpacing: "2px", marginBottom: "2px",
    fontFamily: "'Helvetica Neue', sans-serif",
  },
  menuSectionSub: { fontSize: "11px", color: "#556", marginBottom: "10px", fontFamily: "sans-serif" },
  ttBadge: {
    display: "inline-block", fontSize: "10px", fontWeight: "800", color: "#d4a04a",
    border: "1px solid #d4a04a", borderRadius: "3px", padding: "1px 4px", marginRight: "6px",
    letterSpacing: "1px", verticalAlign: "middle", fontFamily: "monospace",
  },
  atBadge: {
    display: "inline-block", fontSize: "10px", fontWeight: "800", color: "#a78bfa",
    border: "1px solid #7c5cbf", borderRadius: "3px", padding: "1px 4px", marginRight: "6px",
    letterSpacing: "1px", verticalAlign: "middle", fontFamily: "monospace",
  },
  menuGrid: { display: "flex", flexDirection: "column", gap: "8px" },
  menuBtn: {
    display: "flex", justifyContent: "space-between", alignItems: "center",
    background: "transparent", border: "1px solid #333", borderRadius: "8px",
    padding: "14px 16px", cursor: "pointer", color: "#fff", transition: "all 0.15s", textAlign: "left",
  },
  menuBtnLabel: { fontSize: "14px", fontWeight: "600", fontFamily: "'Helvetica Neue', sans-serif" },
  menuBtnRight: { display: "flex", alignItems: "center", gap: "10px" },
  menuBtnInfo: { fontSize: "11px", color: "#667", fontFamily: "sans-serif" },
  checkBtn: {
    display: "inline-flex", alignItems: "center", justifyContent: "center",
    width: "24px", height: "24px", borderRadius: "6px", border: "2px solid #333",
    fontSize: "14px", fontWeight: "900", cursor: "pointer", background: "transparent",
    flexShrink: 0,
  },
  topBar: {
    display: "flex", alignItems: "center", padding: "12px 16px",
    borderBottom: "1px solid #1a1a25", gap: "12px",
  },
  backBtn: {
    background: "transparent", border: "1px solid #333", borderRadius: "6px",
    color: "#999", padding: "6px 12px", fontSize: "12px", cursor: "pointer", fontFamily: "sans-serif",
  },
  topBarTitle: {
    flex: 1, fontSize: "14px", fontWeight: "700", letterSpacing: "1px", color: "#aab",
    fontFamily: "'Helvetica Neue', sans-serif",
  },
  stageInfo: { padding: "16px 24px 8px" },
  stageRow: { display: "flex", alignItems: "baseline", gap: "12px" },
  stageId: {
    fontSize: "22px", fontWeight: "900", color: "#fff", fontFamily: "'Helvetica Neue', sans-serif",
  },
  stageDist: { fontSize: "16px", color: "#667", fontFamily: "sans-serif" },
  stageProgress: { marginLeft: "auto", fontSize: "13px", color: "#445" },
  targetRow: { display: "flex", alignItems: "baseline", gap: "10px", marginTop: "6px" },
  targetLabel: { fontSize: "12px", fontWeight: "700", color: "#c41e3a", letterSpacing: "2px" },
  targetTime: {
    fontSize: "40px", fontWeight: "900", color: "#c41e3a", fontFamily: "'Helvetica Neue', sans-serif",
  },
  timerContainer: { textAlign: "center", padding: "20px 0" },
  timerMain: { display: "inline-flex", alignItems: "baseline" },
  timerSec: {
    fontSize: "120px", fontWeight: "200", lineHeight: 1, letterSpacing: "-4px", color: "#fff",
  },
  timerDot: { fontSize: "80px", fontWeight: "200", color: "#445", lineHeight: 1 },
  timerFrac: {
    fontSize: "64px", fontWeight: "200", color: "#667", lineHeight: 1, letterSpacing: "-2px",
  },
  targetIndicator: {
    fontSize: "48px", fontWeight: "700", marginTop: "12px", fontFamily: "sans-serif", letterSpacing: "0.5px",
  },
  timerLayout: {
    display: "flex", flexDirection: "column", height: "calc(100vh - 49px)",
  },
  timerScrollArea: {
    flex: 1, overflowY: "auto", minHeight: 0,
  },
  btnContainerFixed: {
    padding: "10px 20px", paddingBottom: "max(16px, env(safe-area-inset-bottom))",
    borderTop: "1px solid #1a1a25", backgroundColor: "#0a0a0f", flexShrink: 0,
  },
  startBtn: {
    width: "100%", padding: "18px", borderRadius: "12px", border: "2px solid #22c55e",
    background: "rgba(34, 197, 94, 0.1)", color: "#22c55e", cursor: "pointer", textAlign: "center",
  },
  splitBtn: {
    width: "100%", padding: "18px", borderRadius: "12px", border: "2px solid #c41e3a",
    background: "rgba(196, 30, 58, 0.15)", color: "#fff", cursor: "pointer", textAlign: "center",
  },
  finishBtn: {
    width: "100%", padding: "18px", borderRadius: "12px", border: "2px solid #f59e0b",
    background: "rgba(245, 158, 11, 0.15)", color: "#f59e0b", cursor: "pointer", textAlign: "center",
  },
  btnText: {
    fontSize: "28px", fontWeight: "900", letterSpacing: "4px", fontFamily: "'Helvetica Neue', sans-serif",
  },
  btnSub: { fontSize: "12px", color: "#889", marginTop: "4px", fontFamily: "sans-serif", letterSpacing: "1px" },
  nextStageBar: {
    display: "flex", alignItems: "center", gap: "10px", padding: "8px 24px",
    background: "#111118", margin: "0 24px", borderRadius: "8px", fontFamily: "sans-serif",
  },
  nextLabel: { fontSize: "10px", fontWeight: "700", color: "#556", letterSpacing: "1px" },
  nextId: { fontSize: "13px", fontWeight: "700", color: "#aab" },
  nextDist: { fontSize: "12px", color: "#556" },
  nextTarget: { fontSize: "13px", fontWeight: "700", color: "#aab" },
  splitsList: { padding: "8px 24px 24px" },
  splitsHeader: {
    fontSize: "11px", fontWeight: "700", color: "#445", letterSpacing: "2px",
    marginBottom: "8px", borderBottom: "1px solid #1a1a25", paddingBottom: "6px",
  },
  splitRow: {
    display: "flex", alignItems: "center", padding: "8px 0",
    borderBottom: "1px solid #111118", gap: "8px", fontFamily: "sans-serif",
  },
  splitId: { fontSize: "13px", fontWeight: "700", color: "#aab", width: "70px" },
  splitTarget: { fontSize: "13px", color: "#556", width: "55px" },
  splitActual: { fontSize: "14px", fontWeight: "600", color: "#fff", width: "65px" },
  splitDelta: { fontSize: "14px", fontWeight: "700", marginLeft: "auto", textAlign: "right" },
  doneContainer: { textAlign: "center", padding: "40px 24px 0" },
  doneEmoji: { fontSize: "48px", marginBottom: "12px" },
  doneText: {
    fontSize: "18px", fontWeight: "900", color: "#4ade80", letterSpacing: "3px",
    marginBottom: "24px", fontFamily: "'Helvetica Neue', sans-serif",
  },
  atCard: {
    background: "#111118", border: "1px solid #3b2a5c", borderRadius: "10px",
    padding: "16px", marginBottom: "12px",
  },
  atCardHeader: {
    display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: "4px",
  },
  atId: { fontSize: "14px", fontWeight: "900", color: "#a78bfa", letterSpacing: "1px" },
  atDay: { fontSize: "12px", color: "#556", fontWeight: "700", fontFamily: "sans-serif" },
  atName: {
    fontSize: "20px", fontWeight: "700", color: "#fff",
    fontFamily: "'Helvetica Neue', sans-serif", marginBottom: "8px",
  },
  atDetail: { display: "flex", gap: "20px", marginBottom: "6px" },
  atSpeed: { fontSize: "16px", fontWeight: "700", color: "#a78bfa", fontFamily: "sans-serif" },
  atDist: { fontSize: "14px", color: "#889", fontFamily: "sans-serif" },
  atNote: { fontSize: "11px", color: "#556", fontFamily: "sans-serif" },
  atTip: {
    fontSize: "13px", color: "#889", fontFamily: "sans-serif",
    textAlign: "center", padding: "16px", lineHeight: 1.5,
  },
  shareContainer: {
    padding: "16px 20px 32px", textAlign: "center",
  },
  shareBtn: {
    background: "transparent", border: "1px solid #333", borderRadius: "8px",
    color: "#889", padding: "12px 24px", fontSize: "13px", fontWeight: "700",
    letterSpacing: "2px", cursor: "pointer", fontFamily: "'Helvetica Neue', sans-serif",
  },
  shareMsg: {
    fontSize: "12px", color: "#4ade80", marginTop: "8px", fontFamily: "sans-serif",
  },
  // AT GPS Speed View
  atSpeedLayout: {
    display: "flex", flexDirection: "column", height: "calc(100vh - 49px)",
  },
  atSpeedScrollArea: {
    flex: 1, overflowY: "auto", minHeight: 0,
  },
  atSpeedInfo: {
    padding: "16px 24px 8px",
  },
  atSpeedInfoRow: {
    display: "flex", alignItems: "center", gap: "16px",
  },
  atSpeedDay: {
    fontSize: "13px", fontWeight: "700", color: "#556", fontFamily: "sans-serif",
  },
  atSpeedDist: {
    fontSize: "13px", color: "#667", fontFamily: "sans-serif",
  },
  atSpeedNote: {
    fontSize: "11px", color: "#445", fontFamily: "sans-serif", marginTop: "4px",
  },
  atTargetArea: {
    padding: "12px 24px", display: "flex", alignItems: "baseline", gap: "12px",
  },
  atTargetLabel: {
    fontSize: "12px", fontWeight: "700", color: "#a78bfa", letterSpacing: "2px",
  },
  atTargetSpeed: {
    fontSize: "36px", fontWeight: "900", color: "#a78bfa",
    fontFamily: "'Helvetica Neue', sans-serif",
  },
  atSpeedDisplay: {
    textAlign: "center", padding: "24px 0 12px",
  },
  atCurrentSpeed: {
    fontSize: "120px", fontWeight: "200", lineHeight: 1, letterSpacing: "-4px",
  },
  atSpeedUnit: {
    fontSize: "20px", fontWeight: "700", color: "#445", letterSpacing: "3px",
    marginTop: "4px", fontFamily: "sans-serif", textTransform: "uppercase",
  },
  atDeltaRow: {
    marginTop: "16px",
  },
  atDeltaValue: {
    fontSize: "28px", fontWeight: "700", fontFamily: "sans-serif",
  },
  atDeltaInstruction: {
    fontSize: "16px", fontWeight: "600", letterSpacing: "2px", marginTop: "4px",
    fontFamily: "sans-serif",
  },
  atWaitingText: {
    fontSize: "16px", color: "#556", marginTop: "20px", fontFamily: "sans-serif",
  },
  atErrorText: {
    fontSize: "14px", color: "#ef4444", marginTop: "16px", fontFamily: "sans-serif",
  },
  atUnitToggleRow: {
    textAlign: "center", padding: "8px 0",
  },
  atUnitToggle: {
    display: "inline-flex", borderRadius: "6px", border: "1px solid #333", overflow: "hidden",
  },
  atUnitBtn: {
    padding: "8px 20px", fontSize: "12px", fontWeight: "700", cursor: "pointer",
    border: "none", letterSpacing: "1px", fontFamily: "monospace",
  },
  atUnitBtnActive: {
    background: "#a78bfa", color: "#0a0a0f",
  },
  atUnitBtnInactive: {
    background: "transparent", color: "#667",
  },
  atGpsStatus: {
    fontSize: "11px", fontFamily: "sans-serif", textAlign: "center", padding: "4px 0",
  },
  atStartBtn: {
    width: "100%", padding: "18px", borderRadius: "12px", border: "2px solid #a78bfa",
    background: "rgba(167, 139, 250, 0.1)", color: "#a78bfa", cursor: "pointer", textAlign: "center",
  },
  atStopBtn: {
    width: "100%", padding: "18px", borderRadius: "12px", border: "2px solid #ef4444",
    background: "rgba(239, 68, 68, 0.1)", color: "#ef4444", cursor: "pointer", textAlign: "center",
  },
};

ReactDOM.createRoot(document.getElementById("root")).render(<RallyTimer />);
</script>
</body>
</html>
